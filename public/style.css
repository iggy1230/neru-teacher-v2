/* --- style.css (å®Œå…¨ç‰ˆ v470.18: ã‚·ãƒ¼ãƒ«æ å¤–é…ç½®ï¼†ã‚´ãƒŸç®±ä¿®æ­£ç‰ˆ) --- */

:root {
    --primary-pink: #ff8fa3;
    --primary-blue: #6cd4ff;
    --primary-orange: #ffb46e;
    --primary-yellow: #ffe066;
    --primary-green: #88e0a0;
    --primary-purple: #cd99ff;
    --primary-red: #ff8585;
    --primary-gray: #b0bec5;
    
    --text-color: #333;
    --bg-color: #fff9f0;
}

* {
    box-sizing: border-box;
    touch-action: manipulation;
}

body {
    margin: 0;
    padding: 0;
    font-family: 'M PLUS Rounded 1c', 'Sawarabi Gothic', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    overflow-x: hidden;
    position: relative;
    width: 100%;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}

body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background-image: url('assets/images/background/classroom-bg.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: -1;
}

button { font-family: inherit; }
.hidden { display: none !important; }

#app-container {
    max-width: 600px;
    margin: 0 auto;
    min-height: 100vh;
    position: relative;
    padding-bottom: 40px;
    overflow: hidden;
}

.screen {
    padding: 20px;
    padding-bottom: 80px;
    min-height: 100vh;
    width: 100%;
    box-sizing: border-box;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
.title-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('assets/images/background/neru-title-bg.png');
    background-size: cover;
    background-position: center;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    z-index: 2000;
}

.main-title {
    margin-top: 80px;
    font-size: 3rem;
    color: #d81b60;
    text-shadow: 4px 4px 0 #fff, -2px -2px 0 #fff;
    text-align: center;
    font-weight: 900;
    animation: floatingTitle 3s ease-in-out infinite;
}

@keyframes floatingTitle {
    0% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
    100% { transform: translateY(0); }
}

.title-btn-container {
    margin-bottom: 200px;
    width: 100%;
    display: flex;
    justify-content: center;
}

.title-start-btn {
    background: #ff5252;
    color: white;
    font-size: 1.3rem;
    padding: 15px 40px;
    border-radius: 50px;
    border: 4px solid #fff;
    box-shadow: 0 6px 0 #d32f2f, 0 10px 10px rgba(0, 0, 0, 0.3);
    width: fit-content !important; 
    min-width: auto;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.version-tag {
    position: absolute;
    bottom: 10px;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 0.7rem;
    color: rgba(0, 0, 0, 0.4);
    pointer-events: none;
}

/* ãƒœã‚¿ãƒ³å…±é€š */
.main-btn {
    display: block;
    width: 100%;
    margin: 0 0 12px 0;
    padding: 15px;
    border: none;
    border-radius: 30px;
    font-size: 1.1rem;
    font-weight: bold;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 0 rgba(0, 0, 0, 0.15);
    transition: transform 0.1s;
    text-align: center;
    text-decoration: none;
    text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
}

.main-btn:active { transform: translateY(2px); box-shadow: none; }
.main-btn:disabled { background: #ccc !important; box-shadow: none; cursor: not-allowed; }

.pink-btn { background: var(--primary-pink); box-shadow: 0 4px 0 #e06b85; }
.blue-btn { background: var(--primary-blue); box-shadow: 0 4px 0 #4ba3cc; }
.orange-btn { background: var(--primary-orange); box-shadow: 0 4px 0 #e09230; }
.yellow-btn { background: var(--primary-yellow); box-shadow: 0 4px 0 #e0c240; color: #5d4037; text-shadow: none; }
.green-btn { background: var(--primary-green); box-shadow: 0 4px 0 #5cad72; }
.purple-btn { background: var(--primary-purple); box-shadow: 0 4px 0 #9c6cc4; }
.red-btn { background: var(--primary-red); box-shadow: 0 4px 0 #e06060; }
.gray-btn { background: var(--primary-gray); box-shadow: 0 4px 0 #78909c; }

#main-back-btn {
    position: absolute;
    top: 10px;
    left: 150px; 
    width: auto !important;
    margin: 0 !important;
    padding: 8px 20px !important;
    z-index: 100;
    font-size: 1rem;
    box-shadow: 0 2px 0 #78909c;
}

/* æ ¡é–€ */
#screen-gate {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('assets/images/background/classroom0-bg.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: 1500;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px 20px 20px;
}

#screen-gate > * {
    width: 100%;
    max-width: 600px;
}

.section-title {
    text-align: center;
    font-size: 1.5rem;
    color: white;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000;
    margin: 20px 0;
    font-weight: 900;
    flex-shrink: 0;
}

.gate-layout {
    display: flex;
    justify-content: center;
    width: 100%;
    margin-top: auto;
    margin-bottom: 20px;
    align-items: flex-end;
}

.right-user-list {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    gap: 15px;
    justify-items: center;
    align-content: end;
}

.user-card {
    background: transparent;
    padding: 0;
    text-align: center;
    cursor: pointer;
    position: relative;
    width: 100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 1;
}

.user-card:hover, .user-card:active {
    transform: scale(2.0) translateY(-20px);
    z-index: 1000;
}

.user-card img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    border-radius: 8px;
    background-color: transparent !important;
    filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.3));
    display: block;
    margin: 0 auto;
}

.card-karikari-badge {
    position: static;
    transform: none;
    margin-top: 5px;
    background: rgba(255, 255, 255, 0.95);
    color: #d84315;
    font-size: 0.8rem;
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 10px;
    border: 1px solid #ffab91;
    pointer-events: none;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* å­¦ç”Ÿè¨¼ */
.id-card-wrap {
    position: relative;
    width: 100%;
    max-width: 320px;
    height: auto;
    margin: 0 auto 20px;
    background-color: transparent;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    overflow: hidden;
}

.id-base-img {
    display: block; 
    width: 100%;
    height: auto !important;
    position: relative !important;
    z-index: 1;
}

#id-photo-slot {
    display: block; 
    position: absolute;
    z-index: 2;
    top: 35.75%;
    left: 5.5%;
    width: 30.5%;
    height: 45%;
    background-color: #ddd;
    border-radius: 2px;
    overflow: hidden;
}

#id-photo-slot img {
    width: 100%;
    height: 100%;
    object-fit: cover !important;
    display: block;
}

#id-photo-preview-canvas { display: none; }

.id-text-overlay {
    display: block; 
    position: absolute;
    color: #333;
    font-weight: bold;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    pointer-events: none;
    z-index: 3;
    white-space: nowrap;
    text-align: left;
    line-height: 1;
}

.id-grade-text { top: 38.5%; left: 56%; font-size: 1.3rem; }
.id-name-text { top: 54.25%; left: 56%; font-size: 1.3rem; }

@media (max-width: 350px) {
    .id-grade-text, .id-name-text { font-size: 1.1rem; }
}

.styled-input, .styled-select {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    display: block;
    border: 2px solid #ff85a1;
    border-radius: 10px;
    font-size: 1rem;
}

.upload-buttons-container {
    margin: 15px 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* ãƒ­ãƒ“ãƒ¼ */
.lobby-top { text-align: center; margin: 20px 0; }
.mini-id { 
    transform: scale(0.8); 
    margin-bottom: 0; 
    transform-origin: top center;
    box-shadow: none !important; 
    background: transparent !important; 
}

.edit-profile-btn {
    position: absolute;
    top: 85px; 
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--primary-pink); 
    color: white;
    border: 3px solid white;
    font-size: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    z-index: 100;
}

.edit-profile-btn:active { transform: scale(0.9); }

.edit-profile-btn img {
    width: 54px; 
    height: 54px; 
    object-fit: contain;
    pointer-events: none;
}

.karikari-counter {
    text-align: center;
    font-size: 1.2rem;
    font-weight: bold;
    color: #d84315;
    background: #fff3e0;
    padding: 5px 15px;
    border-radius: 20px;
    display: block; 
    width: fit-content; 
    margin: -20px auto 15px auto; 
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.lobby-menu {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
}

/* ãƒ¡ã‚¤ãƒ³ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.operation-layout { margin-top: 50px; width: 100%; }
.nell-chat { display: flex; align-items: flex-end; margin-bottom: 15px; }
.nell-avatar-wrap { position: relative; width: 100px; height: 100px; flex-shrink: 0; }
.nell-img { width: 100%; height: 100%; object-fit: contain; }

.chat-bubble {
    background: white;
    border-radius: 20px 20px 20px 0;
    padding: 15px;
    margin-left: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    position: relative;
    flex-grow: 1;
}

.chat-bubble::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: -10px;
    border-width: 10px 10px 0 0;
    border-style: solid;
    border-color: white transparent transparent transparent;
}

.chat-bubble p { margin: 0; font-size: 1rem; line-height: 1.5; }

.chalkboard {
    background: #2e7d32;
    color: white;
    padding: 15px;
    border: 8px solid #a1887f;
    border-radius: 5px;
    margin: 10px 0;
    font-family: 'Kiwi Maru', serif;
    min-height: 100px;
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
    width: 100%;
}

.work-area {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 20px;
    padding: 15px;
    margin: 10px 0;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    width: 100%;
}

.camera-btn-large {
    display: block;
    width: 100%;
    padding: 30px 0;
    background: #66bb6a;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    border-radius: 15px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 6px 0 #388e3c;
    margin-bottom: 10px;
}

.camera-btn-large:active { transform: translateY(2px); box-shadow: 0 2px 0 #388e3c; }

.answer-box {
    background: #fff3e0;
    border: 3px solid #ffb74d;
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
    text-align: center;
    font-size: 1.2rem;
    color: #e65100;
    font-weight: bold;
    animation: popIn 0.3s ease;
}

@keyframes popIn {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

/* ã‚²ãƒ¼ãƒ  */
.game-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
}

#game-canvas {
    border: 4px solid #8d6e63;
    border-radius: 10px;
    background: #2e7d32;
    box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 350px;
    height: auto;
    display: block;
}

.game-ui { text-align: center; margin-top: 10px; }
.game-ui p { font-size: 1.2rem; font-weight: bold; color: #d84315; }

/* å•é¡Œãƒªã‚¹ãƒˆãƒ»æ¡ç‚¹çµæœ */
.problem-selection-card {
    display: flex;
    flex-direction: column;
    height: auto; 
    min-height: 400px;
}

.problem-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: 5px;
}

.grade-item {
    background: white;
    border: 2px solid #eee;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.mini-teach-btn {
    background: #2196f3;
    color: white;
    border: none;
    border-radius: 15px;
    padding: 5px 10px;
    font-size: 0.8rem;
    margin-left: auto;
    flex-shrink: 0;
    cursor: pointer;
}

/* ã‚«ãƒªã‚«ãƒªãƒ»ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºï¼ˆå›ºå®šï¼‰ */
.mini-karikari-display {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.95);
    padding: 5px 10px;
    border-radius: 20px;
    font-weight: bold;
    color: #d84315;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 5px;
}

.mini-timer-display {
    position: fixed;
    top: 60px;
    left: 10px; 
    background: #fff3e0; 
    padding: 8px 15px;
    border-radius: 25px;
    font-weight: 900;
    font-size: 1.2rem;
    font-family: 'Kiwi Maru', serif; 
    color: #e64a19; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 3px solid #ffab91;
    cursor: pointer;
    transition: transform 0.1s;
}

.mini-timer-display:active {
    transform: scale(0.95);
}

.glass-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 15px;
    padding: 15px;
    width: 100%;
}

/* å‡ºå¸­ç°¿ */
#attendance-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr); 
    gap: 4px;
    padding: 5px;
    background: #fff;
    border-radius: 10px;
    width: 100%;
}

.attendance-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    max-height: 400px;
    overflow-y: auto;
    padding: 5px;
}

.day-box {
    background: white;
    border-radius: 5px;
    padding: 2px;
    text-align: center;
    font-size: 0.7rem; 
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border: 1px solid #eee;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
.loader-inspect-img {
    width: 200px;
    display: block;
    margin: 0 auto;
    animation: bounce 1s infinite alternate;
}

.progress-bar {
    height: 10px;
    background: #ff85a1;
    width: 0%;
    transition: width 0.3s;
    border-radius: 5px;
}

.progress-container {
    width: 80%;
    background: #eee;
    height: 10px;
    border-radius: 5px;
    margin: 10px auto;
    overflow: hidden;
}

/* ã‚«ãƒ¡ãƒ©ãƒ»ã‚¯ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
.camera-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
}

.camera-container {
    position: relative;
    width: 100%;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

#camera-video, #cropper-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.camera-guide-box {
    position: absolute;
    width: 85%;
    aspect-ratio: 3/4;
    border: 3px solid rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    pointer-events: none;
}

.camera-guide-box p {
    color: white;
    background: rgba(0, 0, 0, 0.5);
    padding: 5px 10px;
    border-radius: 15px;
    margin-top: -40px;
    font-weight: bold;
}

.camera-controls {
    width: 100%;
    height: 120px;
    background: #222;
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding-bottom: 20px;
}

#camera-modal .camera-controls {
    justify-content: center;
    position: relative;
}

#camera-modal #camera-cancel-btn {
    position: absolute;
    right: 20px;
    bottom: 30px;
}

.camera-shutter-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: white;
    border: 5px solid #ccc;
    cursor: pointer;
}

.camera-shutter-btn:active {
    transform: scale(0.9);
    background: #ff5252;
}

.cropper-wrapper {
    position: relative;
    width: 100%;
    flex: 1;
    background: #222;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    touch-action: none;
}

#crop-canvas {
    max-width: 95%;
    max-height: 80vh;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
}

.crop-handle {
    position: absolute;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.4);
    border: 3px solid #ff4081;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    touch-action: none;
}

.crop-handle:active {
    background: #ff4081;
    transform: translate(-50%, -50%) scale(1.2);
}

#crop-lines polyline {
    fill: none;
    stroke: #ff4081;
    stroke-width: 3;
    stroke-dasharray: 5;
}

/* è¨˜æ†¶ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« & Flexboxä¿®æ­£ */
.memory-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 9999;
    display: flex; align-items: center; justify-content: center;
}
.memory-modal-content {
    background: #fff; width: 90%; max-width: 500px; 
    max-height: 80vh; 
    height: auto; 
    border-radius: 15px; padding: 20px;
    display: flex; flex-direction: column; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.memory-list {
    flex: 1; 
    overflow-y: auto; 
    margin: 15px 0;
    border: 1px solid #eee; border-radius: 8px; padding: 10px;
    background: #fafafa;
}
.memory-item {
    display: flex; justify-content: space-between; align-items: flex-start;
    background: white; padding: 10px; margin-bottom: 8px;
    border-radius: 8px; border-bottom: 2px solid #eee;
}
.memory-meta {
    font-size: 0.7rem; color: #888; margin-bottom: 4px;
}
.memory-text {
    font-weight: bold; font-size: 0.9rem; color: #333; word-break: break-all;
}
.memory-role-user { color: #2196f3; }
.memory-role-nell { color: #ff85a1; }
.delete-mem-btn {
    background: #ff5252; color: white; border: none;
    border-radius: 5px; padding: 5px 10px; cursor: pointer;
    font-size: 0.8rem; flex-shrink: 0; margin-left: 10px;
}

/* --- ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ --- */
.timer-box {
    background: #fff; 
    border: 3px solid #ff85a1; 
    border-radius: 15px;
    padding: 10px; 
    margin: 10px 0; 
    text-align: center;
}
.timer-display { 
    font-size: 2rem; 
    font-weight: 900; 
    color: #333; 
    font-family: monospace; 
}
.timer-controls { 
    display: flex; 
    justify-content: center; 
    gap: 5px; 
    margin-top: 5px; 
    flex-wrap: wrap; 
}
.timer-btn {
    background: #ffb74d; 
    color: white; 
    border: none; 
    padding: 8px 12px;
    border-radius: 20px; 
    font-weight: bold; 
    cursor: pointer; 
    font-size: 0.9rem;
}

/* --- Liveã‚«ãƒ¡ãƒ©é–¢é€£ --- */
.mini-cam-btn {
    background: #4a90e2; 
    color: white; 
    border: none; 
    padding: 12px 15px;
    border-radius: 20px; 
    font-weight: bold; 
    cursor: pointer; 
    width: 100%;
    margin-top: 10px; 
    box-shadow: 0 4px 0 #2a609e; 
    display: flex;
    align-items: center; 
    justify-content: center; 
    gap: 8px;
}
.mini-cam-btn:active { 
    transform: translateY(2px); 
    box-shadow: 0 2px 0 #2a609e; 
}

/* â˜…ä¿®æ­£: ã‚¯ãƒ©ã‚¹åŒ–ã—ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ±ä¸€ */
#live-chat-video-container,
.live-chat-video-wrapper {
    width: 100%; 
    max-width: 320px; 
    aspect-ratio: 4/3;
    border-radius: 10px; 
    overflow: hidden;
    border: 4px solid #4a90e2; 
    margin: 10px auto; 
    background: #000;
    display: none;
}

#live-chat-video,
.live-chat-video-elem {
    width: 100%; 
    height: 100%; 
    object-fit: cover;
}

/* --- ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ --- */
.whiteboard-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6); 
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    animation: fadeIn 0.3s ease;
}

.whiteboard-board {
    background: #fff;
    border: 8px solid #8d6e63; 
    border-radius: 15px;
    padding: 20px;
    width: 90%;
    max-width: 350px;
    min-height: 250px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    background-color: #fdfbf7; 
    position: relative;
}

.whiteboard-text {
    font-size: 5rem; 
    font-weight: 900;
    font-family: 'Kiwi Maru', serif; 
    color: #333;
    margin: 20px 0;
    text-align: center;
    word-break: break-all;
    line-height: 1.2;
}

.close-board-btn {
    background: #ff5252;
    color: white;
    border: none;
    padding: 10px 30px;
    border-radius: 30px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 0 #d32f2f;
    font-size: 1rem;
}

.close-board-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #d32f2f;
}

/* --- è¨˜æ†¶ç®¡ç†ã‚¿ãƒ– --- */
.memory-tab {
    flex: 1;
    background: none;
    border: none;
    padding: 8px;
    font-weight: bold;
    color: #888;
    border-bottom: 3px solid transparent;
    cursor: pointer;
}
.memory-tab.active {
    color: #ff85a1;
    border-bottom: 3px solid #ff85a1;
}

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ã‚° */
.profile-section {
    margin-bottom: 15px;
}
.profile-title {
    font-size: 0.9rem;
    color: #555;
    font-weight: bold;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}
.profile-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.profile-tag {
    background: #e3f2fd;
    color: #1565c0;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 5px;
}
.profile-tag-delete {
    background: none;
    border: none;
    color: #ef5350;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    padding: 0;
    margin-left: 5px;
}

.settings-btn-fixed {
    display: none !important;
}

/* éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å›ºå®šè¡¨ç¤º */
.volume-controls-fixed {
    position: fixed; 
    top: 10px; 
    left: 10px; 
    z-index: 9999;
    display: flex; 
    align-items: center; 
    gap: 5px;
    background: rgba(255, 255, 255, 0.7); 
    border-radius: 20px; 
    padding: 5px 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    backdrop-filter: blur(2px);
}

.volume-icon-btn {
    background: transparent;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
}

.volume-slider-bar {
    width: 80px; 
    height: 6px; 
    -webkit-appearance: none; 
    background: #ccc; 
    border-radius: 5px; 
    outline: none;
}

.volume-slider-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #ff85a1;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

/* ãƒãƒƒãƒ—ãƒ”ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.map-pin-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    background-size: cover;
    background-position: center;
    background-color: #eee;
    transition: transform 0.2s;
}
.map-pin-icon:hover {
    transform: scale(1.2);
    z-index: 1000 !important;
    border-color: #ffeb3b;
}

/* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒãƒ¼ã‚¯ç”»åƒ (è‚‰çƒ) */
.rarity-mark {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2px;
}
.rarity-img {
    width: 16px; 
    height: 16px; 
    object-fit: contain;
    filter: drop-shadow(1px 1px 0px rgba(255, 255, 255, 0.8));
}

.rarity-5 .rarity-img {
    animation: bounce 1s infinite alternate;
}

/* 
   â˜…è¿½åŠ : ã‚«ãƒ¡ãƒ©èµ·å‹•æ™‚ã®è»½é‡åŒ–ãƒ¢ãƒ¼ãƒ‰ 
   iPhoneç­‰ã®æç”»è² è·ã‚’è»½æ¸›ã™ã‚‹ãŸã‚ã€é‡ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ç„¡åŠ¹åŒ–
*/
.camera-active .volume-controls-fixed,
.camera-active .glass-card,
.camera-active .whiteboard-overlay,
.camera-active .memory-modal-overlay {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    background: rgba(255, 255, 255, 0.95); /* ã¼ã‹ã—ã®ä»£ã‚ã‚Šã«ãƒ™ã‚¿å¡—ã‚Š(å°‘ã—é€é) */
}

/* ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ã¯èƒŒæ™¯ç”»åƒã‚’éè¡¨ç¤ºã«ã—ã¦æç”»è² è·ã‚’ä¸‹ã’ã‚‹ */
.camera-active body::before {
    display: none !important;
}

/* èƒŒæ™¯ç”»åƒã®ä»£ã‚ã‚Šã«å˜è‰²èƒŒæ™¯ */
.camera-active body {
    background-color: #fff9f0;
}

/*
   â˜…æ–°è¦: ãŠå®ç¥çµŒè¡°å¼±ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (ã‚°ãƒªãƒƒãƒ‰åˆ¶å¾¡å¼·åŒ–ç‰ˆ)
*/
.memory-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr); /* 4è¡Œã«å›ºå®š */
    gap: 4px;
    margin-top: 5px;
    padding: 5px;
    perspective: 1000px;
    /* ç”»é¢é«˜ã•ã®60% -> 70% ã«æ‹¡å¼µã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’ç¸¦é•·ã«ã™ã‚‹ */
    height: 70vh;
    max-height: 500px; /* PCãªã©å¤§ç”»é¢å¯¾ç­– */
}

.memory-card {
    width: 100%;
    height: 100%;
    background-color: transparent; /* ã“ã“ã¯é€æ˜ã«ã™ã‚‹ */
    cursor: pointer;
    position: relative;
    user-select: none;
    border-radius: 5px;
    /* è¦ªè¦ç´ ã«perspectiveãŒã‚ã‚‹å ´åˆã§ã‚‚ã€å­è¦ç´ ã®3Då¤‰æ›ã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
    transform-style: preserve-3d; 
    -webkit-transform-style: preserve-3d;
}

.memory-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.6s;
    transform-style: preserve-3d;
    -webkit-transform-style: preserve-3d; /* iOS Safari fix */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-radius: 5px;
    /* iOSã§ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒã‚°å¯¾ç­–: GPUãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ */
    transform: translateZ(0); 
    -webkit-transform: translateZ(0);
}

.memory-card.flipped .memory-card-inner {
    transform: rotateY(180deg);
    -webkit-transform: rotateY(180deg);
}

.memory-card-front, .memory-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden; /* Safari */
    backface-visibility: hidden;
    border-radius: 5px;
    background-color: #fff;
    /* ãƒãƒ©ã¤ãé˜²æ­¢ */
    transform: translate3d(0,0,0); 
    -webkit-transform: translate3d(0,0,0);
}

.memory-card-back {
    background: linear-gradient(135deg, #66bb6a, #43a047);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    border: 2px solid #fff;
    z-index: 2; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ‰‹å‰ */
    /* è£é¢ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º */
    transform: rotateY(0deg); 
    -webkit-transform: rotateY(0deg);
}

.memory-card-front {
    background-color: white;
    transform: rotateY(180deg);
    -webkit-transform: rotateY(180deg);
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    border: 2px solid #ddd;
    z-index: 1;
}

/* å†™çœŸéƒ¨åˆ†ã®ã‚ºãƒ¼ãƒ è¡¨ç¤ºè¨­å®š (ç”»åƒã®ã¿è¦‹ã›ã‚‹èª¿æ•´) */
.memory-card-img-container {
    width: 100%;
    height: 75%; /* 75%ã«èª¿æ•´ã—ã¦åç§°ã‚¨ãƒªã‚¢ã‚’ç¢ºä¿ */
    overflow: hidden; 
    position: relative;
    background: #f0f0f0;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    border-bottom: 1px solid #eee;
}

.memory-card-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    /* ç”»åƒã‚’ä¸‹ã«ç§»å‹•ã•ã›ã‚‹ãŸã‚ã« object-position ã‚’ 5% ã«å¤‰æ›´ï¼ˆä¸Šç«¯åŸºæº–ã«è¿‘ã¥ã‘ã‚‹ï¼‰ */
    object-position: center 5%; 
    transform: scale(1.6);
    transform-origin: center center;
}

.memory-card-name {
    height: 25%; /* åç§°ã‚¨ãƒªã‚¢ */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.55rem;
    font-weight: bold;
    color: #333;
    padding: 1px 2px;
    line-height: 1.1;
    word-break: break-all;
    background: #fff;
    border-bottom-left-radius: 5px;
    border-bottom-right-radius: 5px;
    text-align: center;
    overflow: hidden;
}

/* ãƒŸãƒ‹ãƒ†ã‚¹ãƒˆãƒ»ã‚¦ãƒ«ãƒˆãƒ©ã‚¯ã‚¤ã‚ºç”¨ãƒœã‚¿ãƒ³ */
.minitest-option-btn, .quiz-option-btn {
    display: block; width: 100%; margin: 8px 0; padding: 15px;
    border: 2px solid #ddd; border-radius: 10px; background: white;
    font-size: 1rem; font-weight: bold; color: #333; cursor: pointer;
    box-shadow: 0 2px 0 #ccc; text-align: left;
}
.minitest-option-btn:active, .quiz-option-btn:active { transform: translateY(2px); box-shadow: none; }
.minitest-correct, .quiz-correct { background: #e8f5e9 !important; border-color: #4caf50 !important; color: #2e7d32 !important; }
.minitest-wrong, .quiz-wrong { background: #ffebee !important; border-color: #ef5350 !important; color: #c62828 !important; }

/* 
   â˜…é‡è¦: ãŠå®å›³é‘‘ã®ã‚«ãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ç”¨ï¼ˆJSã‹ã‚‰ã‚¯ãƒ©ã‚¹ä»˜ä¸ï¼‰
   å¼·åˆ¶çš„ã«ãƒãƒ¼ã‚¸ãƒ³ã¨ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€é‡ãªã‚Šã‚’é˜²ã
*/
.collection-grid-item {
    background: white;
    border-radius: 8px;
    padding: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    text-align: center;
    border: 1px solid #ddd;
    position: relative;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    aspect-ratio: 0.68;
    overflow: hidden;
    z-index: 1;
    
    /* å¤ã„JSã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¼·åˆ¶ä¸Šæ›¸ã */
    margin: 0 !important; 
    transform: none !important;
}

.collection-grid-item:active {
    transform: scale(0.98) !important;
}

.collection-grid-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
}

.collection-grid-item .info-badge {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255,255,255,0.9);
    padding: 2px;
    font-size: 0.6rem;
    font-weight: bold;
    color: #555;
    border-top: 1px solid #eee;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* â˜…ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ²ç¤ºæ¿ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (v416.0è¿½åŠ ) */
.ranking-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 12px;
    padding: 10px 15px;
    margin-bottom: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 1px solid #eee;
}

.top-rank {
    background: #fff3e0;
    border: 2px solid #ffb74d;
    transform: scale(1.02);
}

.current-user-rank {
    background: #e1f5fe;
    border: 2px solid #29b6f6;
}

.rank-left {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    min-width: 0; /* flexå†…ã§çœç•¥ã•ã›ã‚‹ãŸã‚ã«å¿…è¦ */
}

.rank-position {
    width: 30px;
    text-align: center;
    font-weight: 900;
    font-size: 1.2rem;
    color: #555;
}

.rank-medal {
    font-size: 1.5rem;
}

.rank-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    object-fit: contain;
    background: #f0f0f0;
}

.rank-info {
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.rank-name {
    font-weight: bold;
    font-size: 0.95rem;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rank-grade {
    font-size: 0.75rem;
    color: #888;
}

.rank-right {
    text-align: right;
    font-weight: 900;
    color: #e65100;
    font-size: 1.1rem;
    white-space: nowrap;
}

.memory-tab.active-tab {
    font-weight: bold;
}

/* â˜…è¿½åŠ : æ¼¢å­—ãƒ‰ãƒªãƒ«ç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³å¼·åŒ– */
#kanji-question-text, 
#kanji-answer-text,
#kanji-canvas {
    font-family: 'Klee One', 'Zen Kurenaido', cursive;
}

#kanji-game-container {
    background-color: #fffdf5; /* ã‚¯ãƒªãƒ¼ãƒ è‰²ã®ç´™ã£ã½ã„èƒŒæ™¯ */
    background-image: 
        linear-gradient(#e0e0e0 1px, transparent 1px),
        linear-gradient(90deg, #e0e0e0 1px, transparent 1px);
    background-size: 20px 20px;
    background-position: center;
    border: 2px solid #d7ccc8;
    box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
}

#kanji-canvas {
    border: 4px solid #5d4037; /* æ¿ƒã„èŒ¶è‰²ã®æ  */
    background-color: #fff;
    /* åå­—ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆç”°ã®å­—ï¼‰ */
    background-image: 
        linear-gradient(to right, transparent 49.5%, #cfd8dc 50%, transparent 50.5%),
        linear-gradient(to bottom, transparent 49.5%, #cfd8dc 50%, transparent 50.5%);
    background-size: 100% 100%;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    cursor: crosshair;
    display: block;
    margin: 0 auto;
    border-radius: 2px;
    touch-action: none; /* ã‚¹ãƒãƒ›ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æš´ç™ºé˜²æ­¢ */
}

#kanji-controls {
    justify-content: center;
    gap: 15px !important;
}

/* â˜…ä¿®æ­£: èŠ±ä¸¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (ã‚·ãƒ³ãƒ—ãƒ«èµ¤ä¸¸) */
.hanamaru-stamp {
    /* width/heightã¯è¦ªè¦ç´ (#kanji-hanamaru)ã®styleã§åˆ¶å¾¡ */
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(2.0);
    animation: stampAnimation 0.3s ease-out forwards;
    pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯é€é */
    z-index: 100; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚ˆã‚Šå‰é¢ã« */
}

@keyframes stampAnimation {
    0% {
        transform: scale(2.0);
        opacity: 0;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* â˜…æ–°è¦: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.ranking-menu-scroll {
    display: flex;
    overflow-x: auto;
    gap: 8px;
    padding: 10px 5px;
    margin-bottom: 10px;
    -webkit-overflow-scrolling: touch;
    width: 100%; /* å¹…ã‚’æ˜ç¤º */
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’æ“ä½œå¯èƒ½ã«ã™ã‚‹ãŸã‚è¡¨ç¤º (ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´) */
.ranking-menu-scroll::-webkit-scrollbar {
    height: 6px;
}
.ranking-menu-scroll::-webkit-scrollbar-thumb {
    background: rgba(141, 110, 99, 0.4);
    border-radius: 3px;
}
.ranking-menu-scroll::-webkit-scrollbar-track {
    background: transparent;
}

.ranking-tab-btn {
    flex-shrink: 0;
    background: #fff;
    border: 2px solid #8d6e63;
    color: #5d4037;
    border-radius: 20px;
    padding: 8px 15px;
    font-weight: bold;
    font-size: 0.9rem;
    cursor: pointer;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.1s, background 0.1s;
}

.ranking-tab-btn:active {
    transform: scale(0.95);
}

.ranking-tab-btn.active {
    background: #8d6e63;
    color: #fff;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

/* â˜…æ–°è¦: ã‚·ãƒ¼ãƒ«å¸³ (screen-sticker-book) ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (ãƒã‚¤ãƒ³ãƒ€ãƒ¼é¢¨) */
#sticker-board-container {
    width: 100%;
    height: 65vh;
    background: #81d4fa; /* å¤–å´ã®æ°´è‰²ã‚«ãƒãƒ¼ */
    border-radius: 15px;
    position: relative;
    overflow: visible !important; /* â˜…ä¿®æ­£: å°ç´™ã®å¤–ï¼ˆæ å¤–ï¼‰ã«ã‚‚è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
    box-shadow: 
        inset 0 0 10px rgba(0,0,0,0.1),
        0 5px 15px rgba(0,0,0,0.2);
    margin-top: 10px;
    padding: 10px; /* ã‚«ãƒãƒ¼ã®ä½™ç™½ */
    display: flex;
}

/* ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®è¡¨ç´™æ„Ÿ */
#sticker-board-container::before {
    content: "";
    position: absolute;
    top: 5px; bottom: 5px; left: 5px; right: 5px;
    border: 2px dashed rgba(255,255,255,0.5);
    border-radius: 12px;
    pointer-events: none;
}

#sticker-board {
    flex: 1;
    background: #fff; /* ä¸­ã®ç™½ã„ãƒšãƒ¼ã‚¸ */
    border-radius: 8px;
    position: relative;
    overflow: visible; /* â˜…ä¿®æ­£: å°ç´™ã®å¤–ã«ã‚‚è¡¨ç¤º */
    box-shadow: inset 2px 0 5px rgba(0,0,0,0.05);
}

/* ä¸­å¤®ã®ãƒªãƒ³ã‚° */
.binder-ring {
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 20px;
    transform: translateX(-50%);
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 20px,
        #ab47bc 20px,   /* ç´«è‰²ã®ãƒªãƒ³ã‚° */
        #ab47bc 24px,
        transparent 24px,
        transparent 40px
    );
    z-index: 5;
    pointer-events: none;
    filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.2));
}

/* ä¸­å¤®ã®æŠ˜ã‚Šç›® */
#sticker-board::after {
    content: "";
    position: absolute;
    top: 0; bottom: 0; left: 50%;
    width: 1px;
    background: rgba(0,0,0,0.1);
    transform: translateX(-50%);
    z-index: 1;
    pointer-events: none;
}

/* å³å´ã®ç•™ã‚å…· */
.binder-clasp {
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 60px;
    background: #81d4fa;
    border: 2px solid #4fc3f7;
    border-radius: 10px;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.binder-clasp::after {
    content: "";
    width: 15px;
    height: 15px;
    background: #4fc3f7;
    border-radius: 50%;
    box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2);
}

.sticker-item {
    position: absolute;
    cursor: grab;
    user-select: none;
    touch-action: none; /* ã‚¹ãƒãƒ›ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¹²æ¸‰é˜²æ­¢ */
    transition: transform 0.1s;
    filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
}

.sticker-item:active {
    cursor: grabbing;
    filter: drop-shadow(4px 4px 5px rgba(0,0,0,0.4));
    z-index: 1000 !important; 
}

.sticker-img {
    width: 90px; /* åŸºæœ¬ã‚µã‚¤ã‚º 1.5å€ã«æ‹¡å¤§ (60px -> 90px) */
    height: 90px;
    object-fit: contain;
    pointer-events: none; 
}

.sticker-text {
    font-size: 40px;
    line-height: 1;
    pointer-events: none;
}

/* ã‚´ãƒŸç®± */
#sticker-trash {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.9);
    border: 3px solid #ff5252;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 500;
    transition: transform 0.2s, background-color 0.2s;
    pointer-events: none; /* ãƒ‰ãƒ©ãƒƒã‚°åˆ¤å®šã¯JSã®getBoundingClientRectã§è¡Œã†ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆé€éã§å•é¡Œãªã— */
}

#sticker-trash.active {
    transform: scale(1.1);
    background-color: #ffebee;
}

#sticker-trash.hover {
    transform: scale(1.3);
    background-color: #ffcdd2;
    border-color: #d32f2f;
}

/* â˜…æ–°è¦: æ–°ã—ã„ã‚·ãƒ¼ãƒ«ç½®ãå ´ */
.new-sticker-area {
    position: relative; /* ã‚·ãƒ¼ãƒ«ã®çµ¶å¯¾é…ç½®ã®åŸºæº–ã«ãªã‚‹ */
    width: 100%;
    height: 120px; /* ç½®ãå ´ã®é«˜ã• */
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
    margin-top: 15px;
    padding: 10px;
    border: 2px dashed rgba(255, 255, 255, 0.4);
}

.new-sticker-title {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: #5d4037;
    color: white;
    font-size: 0.8rem;
    font-weight: bold;
    padding: 2px 12px;
    border-radius: 10px;
}
```

### 3. `js/ui/sticker.js`

```javascript
// --- js/ui/sticker.js (v1.8: ãƒ­ãƒ¼ã‚«ãƒ«é€£ç•ªï¼†æ–°è¦ã‚·ãƒ¼ãƒ«ç½®ãå ´ å¯¾å¿œç‰ˆ) ---

window.showStickerBook = function(targetUserId = null) {
    window.switchScreen('screen-sticker-book');
    window.updateNellMessage("ã‚·ãƒ¼ãƒ«å¸³ã ã«ã‚ƒï¼è‡ªç”±ã«è²¼ã£ã¦éŠã¶ã«ã‚ƒï¼", "happy");
    
    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè‡ªåˆ† or ä»–äººï¼‰
    const userId = targetUserId || (currentUser ? currentUser.id : null);
    if (!userId) return;

    // èª­ã¿è¾¼ã¿ã¨æç”»
    window.loadAndRenderStickers(userId);
};

window.grantRandomSticker = function(fromLunch = false) {
    if (!currentUser) return;
    
    // â˜…ä¿®æ­£: ã‚·ãƒ¼ãƒ«ã®ç·æ•°ã‚’26ã«è¨­å®š
    const TOTAL_STICKERS = 26;
    
    // 1 ã‹ã‚‰ TOTAL_STICKERS ã¾ã§ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ•´æ•°ã‚’ç”Ÿæˆ
    const num = Math.floor(Math.random() * TOTAL_STICKERS) + 1;
    
    // 3æ¡ã®æ–‡å­—åˆ—ã«å¤‰æ› (ä¾‹: 5 -> "005")
    const numStr = String(num).padStart(3, '0');
    const filePath = `assets/images/sticker/sticker${numStr}.png`;
    
    // æ–°ã—ã„ã‚·ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    // â˜…ä¿®æ­£: åˆæœŸé…ç½®ã‚’ 'newArea'ï¼ˆæ–°è¦ã‚·ãƒ¼ãƒ«ç½®ãå ´ï¼‰ã«è¨­å®š
    const newSticker = {
        id: 'st_' + Date.now() + '_' + Math.floor(Math.random()*1000),
        src: filePath,
        location: 'newArea', 
        x: 10 + Math.random() * 80, // ç½®ãå ´å†…ã§ã®Xåº§æ¨™(%)
        y: 15 + Math.random() * 70, // ç½®ãå ´å†…ã§ã®Yåº§æ¨™(%)
        rotation: (Math.random() * 40 - 20),
        scale: 1.0,
        zIndex: 100 // æœ€å‰é¢ã¸
    };

    if (!currentUser.stickers) currentUser.stickers =[];
    currentUser.stickers.push(newSticker);
    
    // ä¿å­˜
    if (typeof window.saveAndSync === 'function') window.saveAndSync();

    // æ¼”å‡º
    if(window.safePlay) window.safePlay(window.sfxHirameku);
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    const img = new Image();
    img.onload = () => {
        alert(`ğŸ‰ ãŠã‚ã§ã¨ã†ï¼\nç‰¹è£½ã‚·ãƒ¼ãƒ«ã‚’ã‚²ãƒƒãƒˆã—ãŸã«ã‚ƒï¼\nç”»é¢ã®ä¸‹ã®ã€Œã‚ãŸã‚‰ã—ã„ã‚·ãƒ¼ãƒ«ã€ã«ç½®ã„ã¦ãŠã„ãŸã«ã‚ƒï¼`);
    };
    img.onerror = () => {
        // ç”»åƒãŒãªã„å ´åˆã®ã‚¢ãƒ©ãƒ¼ãƒˆ
        alert(`ğŸ‰ ãŠã‚ã§ã¨ã†ï¼\nç‰¹è£½ã‚·ãƒ¼ãƒ«ã‚’ã‚²ãƒƒãƒˆã—ãŸã«ã‚ƒï¼\n(ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã¨ãã¯è‚‰çƒã«ãªã‚‹ã«ã‚ƒ)`);
    };
    img.src = filePath;
};

window.loadAndRenderStickers = async function(userId) {
    const board = document.getElementById('sticker-board');
    const newArea = document.getElementById('new-sticker-area'); 
    if (!board || !newArea) return;
    
    // ä¸­èº«ã‚’ã‚¯ãƒªã‚¢
    board.innerHTML = '';
    newArea.innerHTML = '<div class="new-sticker-title">ã‚ãŸã‚‰ã—ã„ã‚·ãƒ¼ãƒ«</div>';
    
    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ãƒªãƒ³ã‚°ï¼ˆè£…é£¾ï¼‰
    const ring = document.createElement('div');
    ring.className = 'binder-ring';
    board.appendChild(ring);
    
    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ç•™ã‚å…·ï¼ˆè£…é£¾ï¼‰
    const clasp = document.createElement('div');
    clasp.className = 'binder-clasp';
    const container = document.getElementById('sticker-board-container');
    if (container) {
        // ç•™ã‚å…·ã¯containerã«è¿½åŠ 
        const oldClasp = container.querySelector('.binder-clasp');
        if (oldClasp) oldClasp.remove();
        container.appendChild(clasp);
    }
    
    // ã‚¬ã‚¤ãƒ‰ãƒ†ã‚­ã‚¹ãƒˆ
    const guide = document.createElement('div');
    guide.id = 'sticker-guide-text';
    guide.style.cssText = "position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:rgba(0,0,0,0.1); font-weight:bold; pointer-events:none; font-size:2rem; white-space:nowrap;";
    guide.innerText = "STICKER BOOK";
    board.appendChild(guide);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
    let stickers =[];
    
    // è‡ªåˆ†ã‹ã©ã†ã‹åˆ¤å®š
    const isMe = (currentUser && currentUser.id === userId);

    // ã‚´ãƒŸç®±ã®è¡¨ç¤ºåˆ¶å¾¡ (è‡ªåˆ†ã®ã¿)
    const trash = document.getElementById('sticker-trash');
    if (trash) {
        if (isMe) trash.classList.remove('hidden');
        else trash.classList.add('hidden');
    }

    if (isMe) {
        stickers = currentUser.stickers ||[];
    } else {
        // ä»–äººã®ãƒ‡ãƒ¼ã‚¿ã¯Firestoreã‹ã‚‰å–å¾—
        if (db) {
            try {
                const doc = await db.collection("users").doc(String(userId)).get();
                if (doc.exists) {
                    const data = doc.data();
                    stickers = data.stickers ||[];
                    window.updateNellMessage(`${data.name}ã•ã‚“ã®ã‚·ãƒ¼ãƒ«å¸³ã ã«ã‚ƒï¼`, "happy");
                }
            } catch (e) {
                console.error("Sticker Fetch Error:", e);
            }
        }
    }

    // é…ç½®å ´æ‰€ã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹
    stickers.forEach(s => {
        // locationãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã‘ã‚Œã° 'board' ã¨ã¿ãªã™
        const parentEl = (s.location === 'newArea') ? newArea : board;
        const el = window.createStickerElement(s, isMe); 
        parentEl.appendChild(el);
    });
};

window.createStickerElement = function(data, editable = true) {
    const div = document.createElement('div');
    div.className = 'sticker-item';
    div.id = data.id;
    
    // åˆæœŸé…ç½®
    div.style.left = data.x + '%';
    div.style.top = data.y + '%';
    div.style.transform = `translate(-50%, -50%) rotate(${data.rotation || 0}deg) scale(${data.scale || 1})`;
    div.style.zIndex = data.zIndex || 1;

    // ç”»åƒ
    const img = document.createElement('img');
    // data.src ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
    if (data.src) {
        img.src = data.src;
    } else if (window.STICKER_TYPES) {
        // å¤ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®äº’æ›æ€§
        const typeDef = window.STICKER_TYPES.find(t => t.id === data.typeId);
        if (typeDef && typeDef.src) img.src = typeDef.src;
        else img.src = 'assets/images/items/nikukyuhanko.png'; // fallback
    } else {
        img.src = 'assets/images/items/nikukyuhanko.png';
    }
    
    img.className = 'sticker-img';
    
    // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
    img.onerror = () => {
        img.src = 'assets/images/items/nikukyuhanko.png'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒ
    };
    
    div.appendChild(img);

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ² (æ“ä½œãƒ­ã‚¸ãƒƒã‚¯) - è‡ªåˆ†ã®ã‚·ãƒ¼ãƒ«å¸³ã®ã¿æ“ä½œå¯èƒ½
    if (editable) {
        window.attachStickerEvents(div, data);
    } else {
        div.style.cursor = 'default';
    }

    return div;
};

// æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†å›è»¢ & ã‚´ãƒŸç®±ï¼‰
window.attachStickerEvents = function(el, data) {
    let isDragging = false;
    let startX, startY;
    let initialLeft, initialTop;
    let moved = false;
    const trash = document.getElementById('sticker-trash');
    const board = document.getElementById('sticker-board');
    const newArea = document.getElementById('new-sticker-area');

    // ã‚´ãƒŸç®±åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ä¸­å¿ƒç‚¹åˆ¤å®š)
    const isOverTrash = (element) => {
        if (!trash) return false;
        const r1 = element.getBoundingClientRect(); // ã‚·ãƒ¼ãƒ«
        const r2 = trash.getBoundingClientRect();   // ã‚´ãƒŸç®±
        
        // ã‚·ãƒ¼ãƒ«ã®ä¸­å¿ƒç‚¹
        const c1 = { x: r1.left + r1.width / 2, y: r1.top + r1.height / 2 };
        
        // ä¸­å¿ƒç‚¹ãŒã‚´ãƒŸç®±ã®çŸ©å½¢å†…ã«ã‚ã‚‹ã‹
        return (c1.x >= r2.left && c1.x <= r2.right && c1.y >= r2.top && c1.y <= r2.bottom);
    };

    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
    const startDrag = (e) => {
        if (e.target.closest('.main-btn')) return; 
        e.preventDefault();
        e.stopPropagation();

        isDragging = true;
        moved = false;
        
        // æœ€å‰é¢ã¸
        el.style.zIndex = 999;
        
        // ã‚´ãƒŸç®±ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤º
        if (trash) trash.classList.add('active');
        
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«ã€ä¸€æ™‚çš„ã«bodyç›´ä¸‹ã«ç§»å‹•ã•ã›ã‚‹
        // ã“ã‚Œã«ã‚ˆã‚Šã€è¦ªã‚³ãƒ³ãƒ†ãƒŠã® overflow:hidden ã®å½±éŸ¿ã‚’å—ã‘ãªããªã‚‹
        document.body.appendChild(el);

        const clientX = e.touches ? e.touches.clientX : e.clientX;
        const clientY = e.touches ? e.touches.clientY : e.clientY;
        
        // ç”»é¢å…¨ä½“ã§ã®åº§æ¨™ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
        const rect = el.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;
        startX = clientX;
        startY = clientY;
    };

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
    const onDrag = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        
        const clientX = e.touches ? e.touches.clientX : e.clientX;
        const clientY = e.touches ? e.touches.clientY : e.clientY;
        
        const dx = clientX - startX;
        const dy = clientY - startY;
        
        if (Math.abs(dx) > 2 || Math.abs(dy) > 2) moved = true;
        
        // style.left / top ã¯ px ã§æŒ‡å®šã™ã‚‹ (bodyç›´ä¸‹ã«ã‚ã‚‹ãŸã‚)
        el.style.left = `${initialLeft + dx}px`;
        el.style.top = `${initialTop + dy}px`;
        
        // ã‚´ãƒŸç®±ã®ä¸Šã«ã‚ã‚‹ã‹åˆ¤å®šã—ã¦ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
        if (trash) {
            if (isOverTrash(el)) {
                trash.classList.add('hover');
                el.style.opacity = '0.5'; // æ¶ˆãˆã‚‹äºˆå…†
            } else {
                trash.classList.remove('hover');
                el.style.opacity = '1';
            }
        }
    };

    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    const endDrag = (e) => {
        if (!isDragging) return;
        isDragging = false;
        
        // ã‚´ãƒŸç®±ã®ãƒªã‚»ãƒƒãƒˆ
        if (trash) {
            trash.classList.remove('active');
            trash.classList.remove('hover');
        }
        
        // ã‚´ãƒŸç®±åˆ¤å®š
        if (moved && trash && isOverTrash(el)) {
            // å‰Šé™¤å®Ÿè¡Œ
            if (window.sfxBatu) window.safePlay(window.sfxBatu); 
            
            // DOMå‰Šé™¤
            el.remove();
            
            // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            if (currentUser && currentUser.stickers) {
                currentUser.stickers = currentUser.stickers.filter(s => s.id !== data.id);
                if (typeof window.saveAndSync === 'function') window.saveAndSync();
            }
            return; // çµ‚äº†
        }

        // å‰Šé™¤ã•ã‚Œãªã‹ã£ãŸå ´åˆã®ä½ç½®èª¿æ•´
        el.style.opacity = '1';
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸå ´æ‰€ã«ã‚ˆã£ã¦æ‰€å±ã‚³ãƒ³ãƒ†ãƒŠã¨åº§æ¨™ã‚’æ±ºå®š
        const currentRect = el.getBoundingClientRect();
        const boardRect = board.getBoundingClientRect();
        
        let targetParent;
        let finalX, finalY;

        // ãƒœãƒ¼ãƒ‰ã®ä¸Šã‹åˆ¤å®š (å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹)
        if (currentRect.top < boardRect.bottom && currentRect.bottom > boardRect.top) {
            targetParent = board;
            data.location = 'board';
        } else {
            targetParent = newArea;
            data.location = 'newArea';
        }

        const parentRect = targetParent.getBoundingClientRect();
        
        // è¦ªã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã®ç›¸å¯¾ä½ç½®(%)ã‚’è¨ˆç®—
        finalX = ((currentRect.left + currentRect.width / 2) - parentRect.left) / parentRect.width * 100;
        finalY = ((currentRect.top + currentRect.height / 2) - parentRect.top) / parentRect.height * 100;
        
        // DOMãƒ„ãƒªãƒ¼ã‚’æˆ»ã™
        targetParent.appendChild(el);
        
        // %ã§ä½ç½®ã‚’å†è¨­å®š
        el.style.left = `${finalX}%`;
        el.style.top = `${finalY}%`;
        
        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        data.x = finalX;
        data.y = finalY;

        if (!moved) {
            // ã‚¿ãƒƒãƒ—å›è»¢
            data.rotation = (data.rotation || 0) + 45;
            el.style.transform = `translate(-50%, -50%) rotate(${data.rotation}deg) scale(${data.scale || 1})`;
            if (window.sfxBtn) window.safePlay(window.sfxBtn);
        } else {
            // zIndexç¢ºå®š
            data.zIndex = 10 + Math.floor(Math.random() * 50); 
            el.style.zIndex = data.zIndex;
        }
        
        // ä¿å­˜
        if (typeof window.saveAndSync === 'function') window.saveAndSync();
    };

    el.addEventListener('mousedown', startDrag);
    el.addEventListener('touchstart', startDrag, { passive: false });

    window.addEventListener('mousemove', onDrag);
    window.addEventListener('touchmove', onDrag, { passive: false });

    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);
};

window.saveStickers = function() {
    if (!currentUser) return;
    if (typeof window.saveAndSync === 'function') {
        window.saveAndSync();
        alert("ã‚·ãƒ¼ãƒ«å¸³ã‚’ä¿å­˜ã—ãŸã«ã‚ƒï¼");
    }
};

// ==========================================
// â˜… ã¿ã‚“ãªã®ã‚·ãƒ¼ãƒ«å¸³ (ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«)
// ==========================================

window.openStickerUserList = async function() {
    const modal = document.getElementById('sticker-user-modal');
    const listContainer = document.getElementById('sticker-user-list');
    if (!modal || !listContainer) return;
    
    modal.classList.remove('hidden');
    listContainer.innerHTML = '<p style="text-align:center; padding:20px;">èª­ã¿è¾¼ã¿ä¸­ã«ã‚ƒ...</p>';
    
    if (!db) {
        listContainer.innerHTML = '<p style="text-align:center; color:red;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¤ãªãŒã£ã¦ãªã„ã«ã‚ƒ...</p>';
        return;
    }

    try {
        const snapshot = await db.collection("users")
            .orderBy("lastLogin", "desc")
            .limit(20)
            .get();
            
        listContainer.innerHTML = "";
        
        if (snapshot.empty) {
            listContainer.innerHTML = '<p style="text-align:center;">ã¾ã èª°ã‚‚ã„ãªã„ã«ã‚ƒã€‚</p>';
            return;
        }
        
        snapshot.forEach(doc => {
            const user = doc.data();
            
            const div = document.createElement('div');
            div.className = "memory-item"; 
            div.style.alignItems = "center";
            div.style.cursor = "pointer";
            div.onclick = () => {
                window.closeStickerUserList();
                window.showStickerBook(user.id);
            };
            
            const iconSrc = user.photo || 'assets/images/characters/nell-normal.png';
            const stickerCount = (user.stickers && Array.isArray(user.stickers)) ? user.stickers.length : 0;
            
            div.innerHTML = `
                <img src="${iconSrc}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; margin-right:10px; border:1px solid #ddd;">
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#333;">${window.cleanDisplayString(user.name)}</div>
                    <div style="font-size:0.7rem; color:#888;">ã‚·ãƒ¼ãƒ«: ${stickerCount}æš</div>
                </div>
                <button class="mini-teach-btn" style="background:#e91e63;">ã¿ã‚‹</button>
            `;
            listContainer.appendChild(div);
        });
        
    } catch(e) {
        console.error("User List Error:", e);
        listContainer.innerHTML = '<p style="text-align:center; color:red;">èª­ã¿è¾¼ã‚ãªã‹ã£ãŸã«ã‚ƒ...</p>';
    }
};

window.closeStickerUserList = function() {
    const modal = document.getElementById('sticker-user-modal');
    if (modal) modal.classList.add('hidden');
};